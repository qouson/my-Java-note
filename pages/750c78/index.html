<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>分布式 | Qouson&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.png">
    <meta name="description" content="Java技术博客,专注Java学习与总结。">
    <meta name="keywords" content="Java后端博客,个人技术博客,后端,后端开发,后端框架,web后端,后端面试题,技术文档,学习,面试,Spring,Spring MVC,Spring Boot,Mybatis,Redis,Kafka,Zookeeper,Dubbo,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.7c783487.css" as="style"><link rel="preload" href="/assets/js/app.001dee7f.js" as="script"><link rel="preload" href="/assets/js/2.9f32b1ef.js" as="script"><link rel="preload" href="/assets/js/78.c0c6cec9.js" as="script"><link rel="prefetch" href="/assets/js/10.bf6bdccb.js"><link rel="prefetch" href="/assets/js/11.1abb3dd1.js"><link rel="prefetch" href="/assets/js/12.25097659.js"><link rel="prefetch" href="/assets/js/13.83164ea2.js"><link rel="prefetch" href="/assets/js/14.1e2f205b.js"><link rel="prefetch" href="/assets/js/15.46f653de.js"><link rel="prefetch" href="/assets/js/16.0219790a.js"><link rel="prefetch" href="/assets/js/17.c14d2772.js"><link rel="prefetch" href="/assets/js/18.d6e867d4.js"><link rel="prefetch" href="/assets/js/19.bec4eb52.js"><link rel="prefetch" href="/assets/js/20.301c9423.js"><link rel="prefetch" href="/assets/js/21.6c3b3934.js"><link rel="prefetch" href="/assets/js/22.f1ae2c75.js"><link rel="prefetch" href="/assets/js/23.f7a6d7ce.js"><link rel="prefetch" href="/assets/js/24.01a394c9.js"><link rel="prefetch" href="/assets/js/25.168f6a5c.js"><link rel="prefetch" href="/assets/js/26.f3699aa4.js"><link rel="prefetch" href="/assets/js/27.c3e90915.js"><link rel="prefetch" href="/assets/js/28.51103a35.js"><link rel="prefetch" href="/assets/js/29.e1a6c8eb.js"><link rel="prefetch" href="/assets/js/3.a85d349d.js"><link rel="prefetch" href="/assets/js/30.d50c88f6.js"><link rel="prefetch" href="/assets/js/31.14e9be9d.js"><link rel="prefetch" href="/assets/js/32.4e38a35f.js"><link rel="prefetch" href="/assets/js/33.244884f2.js"><link rel="prefetch" href="/assets/js/34.ddc04cb8.js"><link rel="prefetch" href="/assets/js/35.e0abcbeb.js"><link rel="prefetch" href="/assets/js/36.80f619c9.js"><link rel="prefetch" href="/assets/js/37.46a9c9c6.js"><link rel="prefetch" href="/assets/js/38.b02394cc.js"><link rel="prefetch" href="/assets/js/39.96e566a4.js"><link rel="prefetch" href="/assets/js/4.d209647e.js"><link rel="prefetch" href="/assets/js/40.ff1ee370.js"><link rel="prefetch" href="/assets/js/41.4c52f4ff.js"><link rel="prefetch" href="/assets/js/42.63397116.js"><link rel="prefetch" href="/assets/js/43.0d87b11c.js"><link rel="prefetch" href="/assets/js/44.c4b6515c.js"><link rel="prefetch" href="/assets/js/45.520af4b4.js"><link rel="prefetch" href="/assets/js/46.6b651d08.js"><link rel="prefetch" href="/assets/js/47.2e2cc573.js"><link rel="prefetch" href="/assets/js/48.b023f265.js"><link rel="prefetch" href="/assets/js/49.10566b74.js"><link rel="prefetch" href="/assets/js/5.cca480c9.js"><link rel="prefetch" href="/assets/js/50.a9c6f297.js"><link rel="prefetch" href="/assets/js/51.72652a30.js"><link rel="prefetch" href="/assets/js/52.30da4f33.js"><link rel="prefetch" href="/assets/js/53.ae22272c.js"><link rel="prefetch" href="/assets/js/54.db657dae.js"><link rel="prefetch" href="/assets/js/55.6aa60f67.js"><link rel="prefetch" href="/assets/js/56.9e045727.js"><link rel="prefetch" href="/assets/js/57.37702dc8.js"><link rel="prefetch" href="/assets/js/58.387f648b.js"><link rel="prefetch" href="/assets/js/59.f5d96eac.js"><link rel="prefetch" href="/assets/js/6.82001ca2.js"><link rel="prefetch" href="/assets/js/60.bd741a9b.js"><link rel="prefetch" href="/assets/js/61.43bc986c.js"><link rel="prefetch" href="/assets/js/62.1794e555.js"><link rel="prefetch" href="/assets/js/63.086f3156.js"><link rel="prefetch" href="/assets/js/64.53ff57df.js"><link rel="prefetch" href="/assets/js/65.743b1eb9.js"><link rel="prefetch" href="/assets/js/66.291cc462.js"><link rel="prefetch" href="/assets/js/67.d9e67130.js"><link rel="prefetch" href="/assets/js/68.47a77e3d.js"><link rel="prefetch" href="/assets/js/69.02cdd084.js"><link rel="prefetch" href="/assets/js/7.fbb05d84.js"><link rel="prefetch" href="/assets/js/70.039c3c9e.js"><link rel="prefetch" href="/assets/js/71.7df7824f.js"><link rel="prefetch" href="/assets/js/72.b97f78b1.js"><link rel="prefetch" href="/assets/js/73.03a0a0fb.js"><link rel="prefetch" href="/assets/js/74.de7b90a9.js"><link rel="prefetch" href="/assets/js/75.d4acda13.js"><link rel="prefetch" href="/assets/js/76.a21fa6c2.js"><link rel="prefetch" href="/assets/js/77.bda8cd14.js"><link rel="prefetch" href="/assets/js/79.85937016.js"><link rel="prefetch" href="/assets/js/8.417abde4.js"><link rel="prefetch" href="/assets/js/80.dc8c5c6c.js"><link rel="prefetch" href="/assets/js/81.6119b7d5.js"><link rel="prefetch" href="/assets/js/82.afae6245.js"><link rel="prefetch" href="/assets/js/83.24d9bbe3.js"><link rel="prefetch" href="/assets/js/84.426d42e8.js"><link rel="prefetch" href="/assets/js/85.df3568fa.js"><link rel="prefetch" href="/assets/js/86.ca7630d7.js"><link rel="prefetch" href="/assets/js/87.20510d21.js"><link rel="prefetch" href="/assets/js/88.78063b5a.js"><link rel="prefetch" href="/assets/js/9.462a7edb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7c783487.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Qouson's blog" class="logo"> <span class="site-name can-hide">Qouson's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java SE" class="dropdown-title"><a href="/java/" class="link-title">Java SE</a> <span class="title" style="display:none;">Java SE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java 基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/standard/" class="nav-link">基础</a></li><li class="dropdown-subitem"><a href="/java/string/" class="nav-link">String</a></li></ul></li><li class="dropdown-item"><h4>Java 中级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/net/" class="nav-link">网络编程</a></li></ul></li><li class="dropdown-item"><h4>Java 高级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JVM</a></li><li class="dropdown-subitem"><a href="/java/thread/" class="nav-link">多线程</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring框架" class="dropdown-title"><a href="/spring/" class="link-title">Spring框架</a> <span class="title" style="display:none;">Spring框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring/springmvc/" class="nav-link">SpringMVC</a></li><li class="dropdown-item"><!----> <a href="/spring/springboot/" class="nav-link">SpringBoot</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/midware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/midware/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/midware/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/midware/mq/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/midware/zookeeper/" class="nav-link">ZooKeeper</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/more/linux/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/more/designpattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/more/datastructure/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/more/computerscience/" class="nav-link">计算机基础</a></li><li class="dropdown-item"><!----> <a href="/more/javaframework/" class="nav-link">Java相关框架</a></li><li class="dropdown-item"><!----> <a href="/more/distribute/" class="nav-link">分布式</a></li><li class="dropdown-item"><!----> <a href="/more/ddd/" class="nav-link">DDD领域驱动设计</a></li><li class="dropdown-item"><!----> <a href="/more/systemdesign/" class="nav-link">系统设计</a></li><li class="dropdown-item"><!----> <a href="/more/chaos/" class="nav-link">杂乱无章</a></li></ul></div></div><div class="nav-item"><a href="/javamap/" class="nav-link">Java知识图谱</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/qouson/my-java-note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="img/lunhua.png"> <div class="blogger-info"><h3>qouson</h3> <span>Java界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java SE" class="dropdown-title"><a href="/java/" class="link-title">Java SE</a> <span class="title" style="display:none;">Java SE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java 基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/standard/" class="nav-link">基础</a></li><li class="dropdown-subitem"><a href="/java/string/" class="nav-link">String</a></li></ul></li><li class="dropdown-item"><h4>Java 中级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/net/" class="nav-link">网络编程</a></li></ul></li><li class="dropdown-item"><h4>Java 高级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JVM</a></li><li class="dropdown-subitem"><a href="/java/thread/" class="nav-link">多线程</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring框架" class="dropdown-title"><a href="/spring/" class="link-title">Spring框架</a> <span class="title" style="display:none;">Spring框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring/springmvc/" class="nav-link">SpringMVC</a></li><li class="dropdown-item"><!----> <a href="/spring/springboot/" class="nav-link">SpringBoot</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/midware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/midware/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/midware/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/midware/mq/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/midware/zookeeper/" class="nav-link">ZooKeeper</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/more/linux/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/more/designpattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/more/datastructure/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/more/computerscience/" class="nav-link">计算机基础</a></li><li class="dropdown-item"><!----> <a href="/more/javaframework/" class="nav-link">Java相关框架</a></li><li class="dropdown-item"><!----> <a href="/more/distribute/" class="nav-link">分布式</a></li><li class="dropdown-item"><!----> <a href="/more/ddd/" class="nav-link">DDD领域驱动设计</a></li><li class="dropdown-item"><!----> <a href="/more/systemdesign/" class="nav-link">系统设计</a></li><li class="dropdown-item"><!----> <a href="/more/chaos/" class="nav-link">杂乱无章</a></li></ul></div></div><div class="nav-item"><a href="/javamap/" class="nav-link">Java知识图谱</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/qouson/my-java-note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java相关框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>分布式</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/750c78/" aria-current="page" class="active sidebar-link">分布式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/750c78/#cap理论" class="sidebar-link">CAP理论</a></li><li class="sidebar-sub-header level2"><a href="/pages/750c78/#base理论" class="sidebar-link">BASE理论</a></li><li class="sidebar-sub-header level2"><a href="/pages/750c78/#分布式锁" class="sidebar-link">分布式锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/750c78/#数据库" class="sidebar-link">数据库</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#优缺点" class="sidebar-link">优缺点</a></li><li class="sidebar-sub-header level5"><a href="/pages/750c78/#缺点" class="sidebar-link">缺点</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#zookeeper" class="sidebar-link">ZooKeeper</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#实现-2" class="sidebar-link">实现</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#优缺点-2" class="sidebar-link">优缺点</a></li><li class="sidebar-sub-header level5"><a href="/pages/750c78/#缺点-2" class="sidebar-link">缺点</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#redis" class="sidebar-link">Redis</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#实现-3" class="sidebar-link">实现</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#优缺点-3" class="sidebar-link">优缺点</a></li><li class="sidebar-sub-header level5"><a href="/pages/750c78/#优点" class="sidebar-link">优点</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#高并发优化" class="sidebar-link">高并发优化</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/750c78/#分布式事务" class="sidebar-link">分布式事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/750c78/#基于xa协议-需要数据库支持" class="sidebar-link">基于XA协议，需要数据库支持</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_2pc两阶段提交-prepare-commit" class="sidebar-link">2PC两阶段提交（prepare，commit）</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_3pc三阶段提交-cancommit-precommit-docommit" class="sidebar-link">3PC三阶段提交（canCommit，preCommit，doCommit）</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#基于tcc-刚性事务-acid-柔性事务-base-需要手动编写逻辑" class="sidebar-link">基于TCC，刚性事务（ACID），柔性事务（BASE），需要手动编写逻辑</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#本地消息表-mq-最大努力通知" class="sidebar-link">本地消息表+MQ，最大努力通知</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#seata" class="sidebar-link">seata</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/750c78/#幂等性" class="sidebar-link">幂等性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/750c78/#举例" class="sidebar-link">举例</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#解决方案" class="sidebar-link">解决方案</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_1-insert前先select" class="sidebar-link">1.insert前先select</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_2-唯一索引" class="sidebar-link">2.唯一索引</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_3-加悲观锁" class="sidebar-link">3.加悲观锁</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_4-加乐观锁" class="sidebar-link">4.加乐观锁</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_5-建防重表" class="sidebar-link">5.建防重表</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_6-状态机" class="sidebar-link">6.状态机</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_7-分布式锁" class="sidebar-link">7.分布式锁</a></li><li class="sidebar-sub-header level4"><a href="/pages/750c78/#_8-token机制" class="sidebar-link">8.token机制</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/750c78/#限流" class="sidebar-link">限流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/750c78/#计数器" class="sidebar-link">计数器</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#漏桶算法" class="sidebar-link">漏桶算法</a></li><li class="sidebar-sub-header level3"><a href="/pages/750c78/#令牌桶" class="sidebar-link">令牌桶</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DDD领域驱动设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>系统设计</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>python</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>杂乱无章</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/more/#更多" data-v-06225672>更多</a></li><li data-v-06225672><a href="/more/#分布式" data-v-06225672>分布式</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/qouson" target="_blank" title="作者" class="beLink" data-v-06225672>qouson</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-06-02</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">分布式<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="分布式"><a href="#分布式" class="header-anchor">#</a> 分布式</h1> <h2 id="cap理论"><a href="#cap理论" class="header-anchor">#</a> CAP理论</h2> <p>CAP理论又称CAP定理，指的是在一个分布式系统中，Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性），三者不可兼得。</p> <p>一致性（Consistency）：指的是分布式系统中所有节点在同一时刻对某个数据的访问和修改的结果是一致的。</p> <p>可用性（Availability）：指的是分布式系统中任意节点的故障都不会导致整个系统停止对外服务。</p> <p>分区容错性（Partition tolerance）：指的是分布式系统中，当出现网络分区时，仍然可以对外提供服务。</p> <p>Redis的主从架构是AP，即可用性和分区容错性。不能保证强一致性。</p> <p>ZooKeeper的主从架构是CP，即一致性性和分区容错性。不能保证可用性。</p> <h2 id="base理论"><a href="#base理论" class="header-anchor">#</a> BASE理论</h2> <p>BA：Basically Available（基本可用）
S：Soft state（软状态）
E：Eventually consistent（最终一致性）</p> <h2 id="分布式锁"><a href="#分布式锁" class="header-anchor">#</a> 分布式锁</h2> <h3 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h3> <h4 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h4> <ul><li>创建一张锁表，数据库对字段作唯一性约束</li> <li>加锁的时候，在表锁增加一条记录即可</li> <li>释放锁的时候删除这条记录即可</li></ul> <h4 id="优缺点"><a href="#优缺点" class="header-anchor">#</a> 优缺点</h4> <h5 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点</h5> <ul><li>比其他的方式更消耗资源，性能低下</li> <li>设计复杂，容易出错</li> <li>数据库宕机会导致锁失效</li></ul> <h3 id="zookeeper"><a href="#zookeeper" class="header-anchor">#</a> ZooKeeper</h3> <h4 id="实现-2"><a href="#实现-2" class="header-anchor">#</a> 实现</h4> <ul><li>某个资源为目录</li> <li>在这个目录下面的节点就是我们需要获取锁的客户端，每个服务在目录下创建节点，如果的它的节点，序号在目录下最小，那么就获取锁，否则等待</li> <li>释放锁就是删除服务创建的节点</li></ul> <h4 id="优缺点-2"><a href="#优缺点-2" class="header-anchor">#</a> 优缺点</h4> <h5 id="缺点-2"><a href="#缺点-2" class="header-anchor">#</a> 缺点</h5> <ul><li>死锁</li> <li>羊群效应</li> <li>性能没有redis高</li></ul> <h3 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h3> <h4 id="实现-3"><a href="#实现-3" class="header-anchor">#</a> 实现</h4> <ul><li>set key value ex 30 nx</li> <li>Redisson</li></ul> <h4 id="优缺点-3"><a href="#优缺点-3" class="header-anchor">#</a> 优缺点</h4> <h5 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h5> <ul><li>性能高，并发量大</li></ul> <h3 id="高并发优化"><a href="#高并发优化" class="header-anchor">#</a> 高并发优化</h3> <p>把独占锁优化成分段锁</p> <p>提前缓存库存</p> <p>1000个库存拆成10个每个100个库存</p> <ul><li>product_101_stock=1000</li> <li>product_101_stock_1=100</li> <li>...</li></ul> <p><strong>怎么减库存</strong></p> <ul><li>轮询</li> <li>随机</li> <li>权重</li></ul> <h2 id="分布式事务"><a href="#分布式事务" class="header-anchor">#</a> 分布式事务</h2> <h3 id="基于xa协议-需要数据库支持"><a href="#基于xa协议-需要数据库支持" class="header-anchor">#</a> 基于XA协议，需要数据库支持</h3> <h4 id="_2pc两阶段提交-prepare-commit"><a href="#_2pc两阶段提交-prepare-commit" class="header-anchor">#</a> 2PC两阶段提交（prepare，commit）</h4> <ul><li>组成
<ul><li>事务协调者（TC）</li> <li>事务参与者（TM）</li></ul></li> <li>阶段
<ul><li>准备阶段（prepare）：协调者先问各位参与者是否可以提交，等待回应</li> <li>提交阶段（commit）：如果参与者都同意，协调者发送提交请求给参与者，参与者执行事务提交；如果有一个不同意或者超时未回应，则发送中止请求，参与者执行事务回滚</li></ul></li> <li>优缺点
<ul><li>优点</li> <li>缺点
<ul><li>单点问题
<ul><li>事务管理器（协调者）在整个流程扮演重要角色，如果宕机，比如第一节点已完成，在第二节点，正准备提交的时候事务管理器宕机，资源管理器就会一致阻塞，导致数据库无法使用</li></ul></li> <li>同步阻塞
<ul><li>在准备就绪后，资源管理器中的资源就一直处于阻塞，直到提交完成，释放资源。</li></ul></li> <li>数据不一致
<ul><li>虽然是强一致的设计，但仍然存在数据不一致的可能，比如第二阶段中，假设协调者发出了事务commit通知，但是网络问题仅一部分参与者收到了并执行了commit，其余参与者没有收到通知一直处于阻塞状态，这就产生了数据不一致。</li></ul></li></ul></li></ul></li></ul> <h4 id="_3pc三阶段提交-cancommit-precommit-docommit"><a href="#_3pc三阶段提交-cancommit-precommit-docommit" class="header-anchor">#</a> 3PC三阶段提交（canCommit，preCommit，doCommit）</h4> <ul><li>组成
<ul><li>事务协调者（TC）</li> <li>事务参与者（TM）</li></ul></li> <li>阶段
<ul><li>准备阶段（canCommit）：协调者向参与者发送commit请求，参与者如果可以提交就返回yes，否则返回no，让所有参与者做出是否可以提交的决策</li> <li>预提交阶段（preCommit）：所有参与者都返回yes，则向所有参与者发送preCommit请求，进入如preCommit阶段，参与者收到会执行提交事务，并将undo和redo信息记录到日志，如果参与者执行了提交事务，就返回ack，同时等待最终指令。为了确保最后提交阶段之前，各个节点的状态是一致的</li> <li>提交阶段（doCommit）：协调者根据提交阶段的返回，如果全部都执行了提交事务，则向所有参与者发送doCommit请求，并在事务提交之后释放所有事务资源，参与者收到doCommit请求之后，向协调者发送ack，这个阶段的目的时最终确认并提交事务。</li></ul></li> <li>优缺点
<ul><li>优点</li> <li>缺点
<ul><li>无法保证数据100%强一致</li></ul></li></ul></li></ul> <h3 id="基于tcc-刚性事务-acid-柔性事务-base-需要手动编写逻辑"><a href="#基于tcc-刚性事务-acid-柔性事务-base-需要手动编写逻辑" class="header-anchor">#</a> 基于TCC，刚性事务（ACID），柔性事务（BASE），需要手动编写逻辑</h3> <ul><li>阶段
<ul><li>try：主要对业务系统进行检测及资源预留，业务系统执行其分支操作，但不真正提交，如果执行成功，则进入下一阶段，如果执行失败，则直接进行cancel操作</li> <li>commit：如果try成功，则进入commit阶段，执行真正的业务逻辑提交，并释放之前预留的资源</li> <li>cancel：如果try失败，则进入cancel阶段，执行预留资源的释放</li></ul></li></ul> <h3 id="本地消息表-mq-最大努力通知"><a href="#本地消息表-mq-最大努力通知" class="header-anchor">#</a> 本地消息表+MQ，最大努力通知</h3> <h3 id="seata"><a href="#seata" class="header-anchor">#</a> seata</h3> <p>支持XA，两阶段提交
支持AT，最终一致性的两阶段提交
支持TCC，最终一致性
SAGA，长事务模式</p> <h2 id="幂等性"><a href="#幂等性" class="header-anchor">#</a> 幂等性</h2> <h3 id="举例"><a href="#举例" class="header-anchor">#</a> 举例</h3> <ul><li>用户填写表单，保存按钮不小心快速点了两次，表中竟然产生了两条重复的记录，只是id不一样</li> <li>开发人员在项目中为了解决接口超时问题，通常引入重试机制，第一次请求接口超时了，请求方没能及时获取返回结果，于是会对该请求重试几次，这样也会产生重复数据</li> <li>MQ消费者在读消息时候，有时候会读取到重复消息，也会产生重复数据</li></ul> <h3 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h3> <h4 id="_1-insert前先select"><a href="#_1-insert前先select" class="header-anchor">#</a> 1.insert前先select</h4> <p>在保存数据的接口中，在insert前先根据requestId等字段先select一下数据，如果该数据已存在，直接返回，如果不存在，才执行insert</p> <h4 id="_2-唯一索引"><a href="#_2-唯一索引" class="header-anchor">#</a> 2.唯一索引</h4> <p>加唯一索引是个非常简单但有效的办法，如果重复插入数据，会抛出异常，为了保证幂等性，一般要捕获这个异常，Java-DuplicateKeyException。Spring-MySQLIntegerityConstraintViolationException</p> <h4 id="_3-加悲观锁"><a href="#_3-加悲观锁" class="header-anchor">#</a> 3.加悲观锁</h4> <p>更新逻辑，比如更新用户余额，可以加悲观锁，把对应用户的那一行数据锁住。同一时刻只允许一个请求获得锁，其他请求则等待</p> <p>select  * from user id = 123 for update;</p> <p>缺点：获取不到锁的请求一般只能报失败，比较难保证接口返回相同值</p> <h4 id="_4-加乐观锁"><a href="#_4-加乐观锁" class="header-anchor">#</a> 4.加乐观锁</h4> <p>更新逻辑，可以用乐观锁，性能更好。可以在表中增加一个timestamp或者version字段</p> <p>在更新前，先查询数据，将version作为更新的条件，同时也更新version</p> <p>update user set amount = amount + 100，version = version + 1 where id = 123 and version = 1</p> <h4 id="_5-建防重表"><a href="#_5-建防重表" class="header-anchor">#</a> 5.建防重表</h4> <p>有时候表中并非所有场景都不允许产生重复数据，只有某些特定场景才不允许。这时候可以使用防重表的方式</p> <p>例如消息消费中，创建防重表，存储消息的唯一id，消费时候先去查询是否已经消费，已经消费直接返回成功。</p> <h4 id="_6-状态机"><a href="#_6-状态机" class="header-anchor">#</a> 6.状态机</h4> <p>有些业务表是有状态的，比如订单表中有：1-下单，2-已支付，3-完成，4-撤销。可以通过限制状态的流动来完成幂等。</p> <h4 id="_7-分布式锁"><a href="#_7-分布式锁" class="header-anchor">#</a> 7.分布式锁</h4> <p>直接在数据库上加锁的做法性能不友好，可以使用分布式锁的方式，目前最流行的分布式锁是通过Redis，具体一般是用Redisson</p> <h4 id="_8-token机制"><a href="#_8-token机制" class="header-anchor">#</a> 8.token机制</h4> <p>请求接口之前需要先获取一个唯一的token，再带着这个token去完成业务操作，服务端根据这个token是否存在，来判断是否重复请求</p> <h2 id="限流"><a href="#限流" class="header-anchor">#</a> 限流</h2> <h3 id="计数器"><a href="#计数器" class="header-anchor">#</a> 计数器</h3> <p>简单粗暴，比如要限制1s内能通过的请求数。实现思路就是第一个请求进来开始计数，在接下来1s内，每个请求进来请求数+1，超过最大请求数的请求会被拒绝，等到1结束后计数清零，重新开始计数</p> <p>缺点</p> <p>比如前10ms已经通过了最大的请求书，那么后面990ms的请求只能拒绝，这种现象叫做“突刺现象”</p> <h3 id="漏桶算法"><a href="#漏桶算法" class="header-anchor">#</a> 漏桶算法</h3> <h3 id="令牌桶"><a href="#令牌桶" class="header-anchor">#</a> 令牌桶</h3></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/qouson/my-java-note/edit/master/docs/40.更多/70.分布式/00.分布式.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/06/02, 12:04:18</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/04b2c7/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">MyBatis</div></a> <a href="/pages/f4cce2/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">DDD</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/04b2c7/" class="prev">MyBatis</a></span> <span class="next"><a href="/pages/f4cce2/">DDD</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/ce67c7/"><div>
            杂乱无章
            <!----></div></a> <span class="date">12-25</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/fb8108/"><div>
            基础-大彬
            <!----></div></a> <span class="date">11-14</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/b31312/"><div>
            集合-大彬
            <!----></div></a> <span class="date">11-14</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jiangjinchao1642@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/qouson" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2025
    <span>qouson</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.001dee7f.js" defer></script><script src="/assets/js/2.9f32b1ef.js" defer></script><script src="/assets/js/78.c0c6cec9.js" defer></script>
  </body>
</html>
