<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql | Qouson&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/logo.png">
    <meta name="description" content="Java技术博客,专注Java学习与总结。">
    <meta name="keywords" content="Java后端博客,个人技术博客,后端,后端开发,后端框架,web后端,后端面试题,技术文档,学习,面试,Spring,Spring MVC,Spring Boot,Mybatis,Redis,Kafka,Zookeeper,Dubbo,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.ada71c49.css" as="style"><link rel="preload" href="/assets/js/app.a811c800.js" as="script"><link rel="preload" href="/assets/js/2.06722832.js" as="script"><link rel="preload" href="/assets/js/35.7a4be827.js" as="script"><link rel="prefetch" href="/assets/js/10.a57c9c9b.js"><link rel="prefetch" href="/assets/js/11.965cea58.js"><link rel="prefetch" href="/assets/js/12.43d06000.js"><link rel="prefetch" href="/assets/js/13.66ce2c61.js"><link rel="prefetch" href="/assets/js/14.c1ec3892.js"><link rel="prefetch" href="/assets/js/15.360b302b.js"><link rel="prefetch" href="/assets/js/16.f5c99d66.js"><link rel="prefetch" href="/assets/js/17.f86eb43c.js"><link rel="prefetch" href="/assets/js/18.33a9e614.js"><link rel="prefetch" href="/assets/js/19.b055d8a6.js"><link rel="prefetch" href="/assets/js/20.1752c0a9.js"><link rel="prefetch" href="/assets/js/21.f338c068.js"><link rel="prefetch" href="/assets/js/22.3dfa9cf8.js"><link rel="prefetch" href="/assets/js/23.74d81a1d.js"><link rel="prefetch" href="/assets/js/24.945f547d.js"><link rel="prefetch" href="/assets/js/25.e49e2741.js"><link rel="prefetch" href="/assets/js/26.d801af92.js"><link rel="prefetch" href="/assets/js/27.567f917f.js"><link rel="prefetch" href="/assets/js/28.a997501a.js"><link rel="prefetch" href="/assets/js/29.e26968d6.js"><link rel="prefetch" href="/assets/js/3.47e90fde.js"><link rel="prefetch" href="/assets/js/30.0b8c4e46.js"><link rel="prefetch" href="/assets/js/31.9c518480.js"><link rel="prefetch" href="/assets/js/32.28515fda.js"><link rel="prefetch" href="/assets/js/33.0cfcf1b9.js"><link rel="prefetch" href="/assets/js/34.4b9600fc.js"><link rel="prefetch" href="/assets/js/36.f71da370.js"><link rel="prefetch" href="/assets/js/37.3f64a0dd.js"><link rel="prefetch" href="/assets/js/38.efa5b64f.js"><link rel="prefetch" href="/assets/js/39.bde42687.js"><link rel="prefetch" href="/assets/js/4.477da08c.js"><link rel="prefetch" href="/assets/js/40.fab538ad.js"><link rel="prefetch" href="/assets/js/41.0ccec46a.js"><link rel="prefetch" href="/assets/js/42.4a6de99f.js"><link rel="prefetch" href="/assets/js/43.e653d26d.js"><link rel="prefetch" href="/assets/js/44.3965a686.js"><link rel="prefetch" href="/assets/js/45.bf7693be.js"><link rel="prefetch" href="/assets/js/46.bfafeb08.js"><link rel="prefetch" href="/assets/js/47.83bbe3d6.js"><link rel="prefetch" href="/assets/js/48.f42c945a.js"><link rel="prefetch" href="/assets/js/49.ff2457cb.js"><link rel="prefetch" href="/assets/js/5.12b1503c.js"><link rel="prefetch" href="/assets/js/50.00485604.js"><link rel="prefetch" href="/assets/js/51.24c7d9ea.js"><link rel="prefetch" href="/assets/js/52.5ca4ff53.js"><link rel="prefetch" href="/assets/js/53.bb1586ed.js"><link rel="prefetch" href="/assets/js/54.793cc54f.js"><link rel="prefetch" href="/assets/js/55.b845e6f7.js"><link rel="prefetch" href="/assets/js/56.3eb783da.js"><link rel="prefetch" href="/assets/js/57.7cc78a6e.js"><link rel="prefetch" href="/assets/js/58.f080c773.js"><link rel="prefetch" href="/assets/js/59.9f5d8d5f.js"><link rel="prefetch" href="/assets/js/6.8f2b7579.js"><link rel="prefetch" href="/assets/js/60.a9d3c94a.js"><link rel="prefetch" href="/assets/js/61.bc242f5b.js"><link rel="prefetch" href="/assets/js/7.a987c790.js"><link rel="prefetch" href="/assets/js/8.c07b8e58.js"><link rel="prefetch" href="/assets/js/9.8a94162e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ada71c49.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Qouson's blog" class="logo"> <span class="site-name can-hide">Qouson's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java SE" class="dropdown-title"><a href="/java/" class="link-title">Java SE</a> <span class="title" style="display:none;">Java SE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java 基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/standard/" class="nav-link">基础</a></li><li class="dropdown-subitem"><a href="/java/string/" class="nav-link">String</a></li></ul></li><li class="dropdown-item"><h4>Java 中级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/net/" class="nav-link">网络编程</a></li></ul></li><li class="dropdown-item"><h4>Java 高级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JVM</a></li><li class="dropdown-subitem"><a href="/java/thread/" class="nav-link">多线程</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring框架" class="dropdown-title"><a href="/spring/" class="link-title">Spring框架</a> <span class="title" style="display:none;">Spring框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring/springmvc/" class="nav-link">SpringMVC</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/midware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/midware/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/midware/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/midware/mq/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/midware/zookeeper/" class="nav-link">ZooKeeper</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/more/linux/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/more/designpattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/more/datastructure/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><a href="/javamap/" class="nav-link">Java知识图谱</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/qouson/my-java-note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="img/lunhua.png"> <div class="blogger-info"><h3>qouson</h3> <span>Java界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java SE" class="dropdown-title"><a href="/java/" class="link-title">Java SE</a> <span class="title" style="display:none;">Java SE</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java 基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/standard/" class="nav-link">基础</a></li><li class="dropdown-subitem"><a href="/java/string/" class="nav-link">String</a></li></ul></li><li class="dropdown-item"><h4>Java 中级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/net/" class="nav-link">网络编程</a></li></ul></li><li class="dropdown-item"><h4>Java 高级</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/java/jvm/" class="nav-link">JVM</a></li><li class="dropdown-subitem"><a href="/java/thread/" class="nav-link">多线程</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Spring框架" class="dropdown-title"><a href="/spring/" class="link-title">Spring框架</a> <span class="title" style="display:none;">Spring框架</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/spring/spring/" class="nav-link">Spring</a></li><li class="dropdown-item"><!----> <a href="/spring/springmvc/" class="nav-link">SpringMVC</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="中间件" class="dropdown-title"><a href="/midware/" class="link-title">中间件</a> <span class="title" style="display:none;">中间件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/midware/mysql/" class="nav-link">MySQL</a></li><li class="dropdown-item"><!----> <a href="/midware/redis/" class="nav-link">Redis</a></li><li class="dropdown-item"><!----> <a href="/midware/mq/" class="nav-link">MQ</a></li><li class="dropdown-item"><!----> <a href="/midware/zookeeper/" class="nav-link">ZooKeeper</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/more/git/" class="nav-link">git</a></li><li class="dropdown-item"><!----> <a href="/more/linux/" class="nav-link">linux</a></li><li class="dropdown-item"><!----> <a href="/more/designpattern/" class="nav-link">设计模式</a></li><li class="dropdown-item"><!----> <a href="/more/datastructure/" class="nav-link">数据结构与算法</a></li></ul></div></div><div class="nav-item"><a href="/javamap/" class="nav-link">Java知识图谱</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/qouson/my-java-note" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>mysql</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/bcda02/" aria-current="page" class="active sidebar-link">mysql</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#mysql架构" class="sidebar-link">mysql架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#myisam和innodb区别" class="sidebar-link">MyISAM和InnoDB区别</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#索引优化分析" class="sidebar-link">索引优化分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#性能下降sql执行慢-执行时间长-等待时间长" class="sidebar-link">性能下降SQL执行慢/执行时间长/等待时间长</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#常见通用的join查询" class="sidebar-link">常见通用的Join查询</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#索引简介" class="sidebar-link">索引简介</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#explain性能分析" class="sidebar-link">Explain性能分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#概念" class="sidebar-link">概念</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#explain-准备工作" class="sidebar-link">Explain 准备工作</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#id" class="sidebar-link">id</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#select-type" class="sidebar-link">select_type</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#table" class="sidebar-link">table</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#type" class="sidebar-link">type</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#possible-keys" class="sidebar-link">possible_keys</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#key" class="sidebar-link">key</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#key-len" class="sidebar-link">key_len</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#ref" class="sidebar-link">ref</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#rows" class="sidebar-link">rows</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#extra" class="sidebar-link">Extra</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#常见索引失效以及优化" class="sidebar-link">常见索引失效以及优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#前期准备" class="sidebar-link">前期准备</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#全值匹配我最爱" class="sidebar-link">全值匹配我最爱</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#最佳左前缀法则" class="sidebar-link">最佳左前缀法则</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#不要在索引列上做任何计算" class="sidebar-link">不要在索引列上做任何计算</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#索引列上不能有范围查询" class="sidebar-link">索引列上不能有范围查询</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#尽量使用覆盖索引" class="sidebar-link">尽量使用覆盖索引</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#使用不等于-或者-的时候" class="sidebar-link">使用不等于(!= 或者)的时候</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#字段的-is-not-null-和-is-null" class="sidebar-link">字段的 is not null 和 is null</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#like-的前后模糊匹配" class="sidebar-link">like 的前后模糊匹配</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#减少使用-or" class="sidebar-link">减少使用 or</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#口诀" class="sidebar-link">口诀</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#关联查询优化" class="sidebar-link">关联查询优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#关联查询优化前期准备" class="sidebar-link">关联查询优化前期准备</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#案例" class="sidebar-link">案例</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#子查询优化" class="sidebar-link">子查询优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#子查询优化案例" class="sidebar-link">子查询优化案例</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#排序分组优化" class="sidebar-link">排序分组优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#无过滤不索引" class="sidebar-link">无过滤不索引</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#顺序错-必排序" class="sidebar-link">顺序错，必排序</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#方向反-必排序" class="sidebar-link">方向反，必排序</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#索引的选择" class="sidebar-link">索引的选择</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#using-filesort" class="sidebar-link">using filesort</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#使用覆盖索引" class="sidebar-link">使用覆盖索引</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#group-by" class="sidebar-link">group by</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#截取查询分析" class="sidebar-link">截取查询分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#慢查询分析" class="sidebar-link">慢查询分析</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#show-processlist" class="sidebar-link">SHOW PROCESSLIST</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#主从复制" class="sidebar-link">主从复制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#复制的基本原理" class="sidebar-link">复制的基本原理</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#复制的基本原则" class="sidebar-link">复制的基本原则</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#复制的最大问题" class="sidebar-link">复制的最大问题</a></li><li class="sidebar-sub-header level3"><a href="/pages/bcda02/#一主一从常见配置" class="sidebar-link">一主一从常见配置</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/bcda02/#速查表" class="sidebar-link">速查表</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mq</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>zookeeper</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/midware/#中间件" data-v-06225672>中间件</a></li><li data-v-06225672><a href="/midware/#mysql" data-v-06225672>mysql</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/qouson" target="_blank" title="作者" class="beLink" data-v-06225672>qouson</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-05-23</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">mysql<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="mysql"><a href="#mysql" class="header-anchor">#</a> mysql</h1> <h2 id="mysql架构"><a href="#mysql架构" class="header-anchor">#</a> mysql架构</h2> <h3 id="myisam和innodb区别"><a href="#myisam和innodb区别" class="header-anchor">#</a> MyISAM和InnoDB区别</h3> <table><thead><tr><th>对比项</th> <th>MyISAM</th> <th>InnoDB</th></tr></thead> <tbody><tr><td>主外键</td> <td>不支持</td> <td>支持</td></tr> <tr><td>事务</td> <td>不支持</td> <td>支持</td></tr> <tr><td>行表锁</td> <td>表锁，即使操作一条记录，也会锁整个表 ，不适合高并发的操作</td> <td>行锁，操作时只锁某一行，不对其他行有影响，<strong>适合高并发操作</strong></td></tr> <tr><td>缓存</td> <td>只缓存索引，不缓存真实数据</td> <td>不仅缓存索引，还缓存真实数据，对内存要求较高，而且内存大小对性能有决定性影响</td></tr> <tr><td>表空间</td> <td>小</td> <td>大</td></tr> <tr><td>关注点</td> <td>性能</td> <td>事务</td></tr> <tr><td>默认安装</td> <td>Y</td> <td>Y</td></tr></tbody></table> <h2 id="索引优化分析"><a href="#索引优化分析" class="header-anchor">#</a> 索引优化分析</h2> <h3 id="性能下降sql执行慢-执行时间长-等待时间长"><a href="#性能下降sql执行慢-执行时间长-等待时间长" class="header-anchor">#</a> 性能下降SQL执行慢/执行时间长/等待时间长</h3> <ul><li>查询语句写的烂</li> <li>索引失效
<ul><li>单值</li> <li>复合</li></ul></li> <li>关联查询太多join（设计缺陷或不得已的需求）</li> <li>服务器调优以及各个参数设置（缓冲，线程数等）</li></ul> <h3 id="常见通用的join查询"><a href="#常见通用的join查询" class="header-anchor">#</a> 常见通用的Join查询</h3> <ul><li>sql执行顺序
<ul><li>手写
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210626201950.png" alt="20210626201950"></li> <li>机读
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210626202501.png" alt="20210626202501"></li> <li>总结
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210626202356.png" alt="20210626202356"></li></ul></li> <li>join图
<ul><li><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210626202722.png" alt="20210626202722"></li> <li><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210626202905.png" alt="20210626202905"></li></ul></li> <li>建表sql</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_dept<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>deptName<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>address<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_emp<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> empno <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_dept_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token comment">#CONSTRAINT `fk_dept_id` FOREIGN KEY (`deptId`) REFERENCES `t_dept` (`id`)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>address<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'华山'</span><span class="token punctuation">,</span><span class="token string">'华山'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>address<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'丐帮'</span><span class="token punctuation">,</span><span class="token string">'洛阳'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>address<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'峨眉'</span><span class="token punctuation">,</span><span class="token string">'峨眉山'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>address<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'武当'</span><span class="token punctuation">,</span><span class="token string">'武当山'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>address<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'明教'</span><span class="token punctuation">,</span><span class="token string">'光明顶'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_dept<span class="token punctuation">(</span>deptName<span class="token punctuation">,</span>address<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'少林'</span><span class="token punctuation">,</span><span class="token string">'少林寺'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'风清扬'</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'岳不群'</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100002</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'令狐冲'</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100003</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'洪七公'</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">100004</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'乔峰'</span><span class="token punctuation">,</span><span class="token number">35</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">100005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'灭绝师太'</span><span class="token punctuation">,</span><span class="token number">70</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">100006</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'周芷若'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">100007</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'张三丰'</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">100008</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'张无忌'</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">100009</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t_emp<span class="token punctuation">(</span>NAME<span class="token punctuation">,</span>age<span class="token punctuation">,</span>deptId<span class="token punctuation">,</span>empno<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span><span class="token string">'韦小宝'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token boolean">null</span><span class="token punctuation">,</span><span class="token number">100010</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ul><li>7种join</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">1.</span>所有有门派人员的信息（要求显示门派名称）
<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span>d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptName<span class="token punctuation">`</span></span> <span class="token keyword">FROM</span> t_emp e <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> t_dept d <span class="token keyword">ON</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span><span class="token operator">=</span>d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token number">2.</span> 列出所有人员及其门派信息
<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span><span class="token punctuation">,</span>d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptName<span class="token punctuation">`</span></span> <span class="token keyword">FROM</span> t_emp e <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_dept d <span class="token keyword">ON</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span><span class="token operator">=</span>d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token number">3.</span> 列出所有门派
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_dept<span class="token punctuation">;</span>
<span class="token number">4.</span> 所有无门派人士
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_emp <span class="token keyword">WHERE</span> deptId <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token number">5.</span> 所有无人门派
<span class="token keyword">SELECT</span> d<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> t_dept d <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_emp e <span class="token keyword">ON</span> d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token operator">=</span>e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span> <span class="token keyword">WHERE</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token number">6.</span> 所有人员和门派的对应关系
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_emp e <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_dept d <span class="token keyword">ON</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span><span class="token operator">=</span>d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_emp e <span class="token keyword">RIGHT</span> <span class="token keyword">JOIN</span> t_dept d <span class="token keyword">ON</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span><span class="token operator">=</span>d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token number">7.</span> 所有没有入门派的人员和没人入的门派
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_emp e <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_dept d <span class="token keyword">ON</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span><span class="token operator">=</span>d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">WHERE</span> e<span class="token punctuation">.</span>deptId <span class="token operator">IS</span> <span class="token boolean">NULL</span>
<span class="token keyword">UNION</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> t_dept d <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_emp e <span class="token keyword">ON</span> d<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token operator">=</span>e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span> <span class="token keyword">WHERE</span> e<span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span> <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span>
<span class="token number">8.</span> 添加 CEO 字段
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t_dept<span class="token punctuation">`</span></span> <span class="token keyword">add</span> CEO <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">update</span> t_dept <span class="token keyword">set</span> CEO<span class="token operator">=</span><span class="token number">2</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> t_dept <span class="token keyword">set</span> CEO<span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> t_dept <span class="token keyword">set</span> CEO<span class="token operator">=</span><span class="token number">6</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> t_dept <span class="token keyword">set</span> CEO<span class="token operator">=</span><span class="token number">8</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> t_dept <span class="token keyword">set</span> CEO<span class="token operator">=</span><span class="token number">9</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
<span class="token number">8.1</span> 求各个门派对应的掌门人名称
<span class="token keyword">SELECT</span> d<span class="token punctuation">.</span>deptName<span class="token punctuation">,</span>e<span class="token punctuation">.</span>name <span class="token keyword">FROM</span> t_dept d <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_emp e <span class="token keyword">ON</span> d<span class="token punctuation">.</span>ceo<span class="token operator">=</span>e<span class="token punctuation">.</span>id
<span class="token number">8.2</span> 求所有当上掌门人的平均年龄
<span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>age<span class="token punctuation">)</span> <span class="token keyword">FROM</span> t_dept d <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_emp e <span class="token keyword">ON</span> d<span class="token punctuation">.</span>ceo<span class="token operator">=</span>e<span class="token punctuation">.</span>id
<span class="token number">8.3</span> 求所有人物对应的掌门名称
<span class="token keyword">SELECT</span> ed<span class="token punctuation">.</span>name <span class="token string">'人物'</span><span class="token punctuation">,</span>c<span class="token punctuation">.</span>name <span class="token string">'掌门'</span> <span class="token keyword">FROM</span>
<span class="token punctuation">(</span><span class="token keyword">SELECT</span> e<span class="token punctuation">.</span>name<span class="token punctuation">,</span>d<span class="token punctuation">.</span>ceo <span class="token keyword">from</span> t_emp e <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_dept d <span class="token keyword">on</span> e<span class="token punctuation">.</span>deptid<span class="token operator">=</span>d<span class="token punctuation">.</span>id<span class="token punctuation">)</span> ed
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_emp c <span class="token keyword">on</span> ed<span class="token punctuation">.</span>ceo<span class="token operator">=</span> c<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> e<span class="token punctuation">.</span>name <span class="token string">'人物'</span><span class="token punctuation">,</span>tmp<span class="token punctuation">.</span>name <span class="token string">'掌门'</span> <span class="token keyword">FROM</span> t_emp e <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> d<span class="token punctuation">.</span>id did<span class="token punctuation">,</span>e<span class="token punctuation">.</span>name <span class="token keyword">FROM</span> t_dept d <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_emp e <span class="token keyword">ON</span> d<span class="token punctuation">.</span>ceo<span class="token operator">=</span>e<span class="token punctuation">.</span>id<span class="token punctuation">)</span>tmp
<span class="token keyword">ON</span> e<span class="token punctuation">.</span>deptId<span class="token operator">=</span>tmp<span class="token punctuation">.</span>did<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> e1<span class="token punctuation">.</span>name <span class="token string">'人物'</span><span class="token punctuation">,</span>e2<span class="token punctuation">.</span>name <span class="token string">'掌门'</span> <span class="token keyword">FROM</span> t_emp e1
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_dept d <span class="token keyword">on</span> e1<span class="token punctuation">.</span>deptid <span class="token operator">=</span> d<span class="token punctuation">.</span>id
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_emp e2 <span class="token keyword">on</span> d<span class="token punctuation">.</span>ceo <span class="token operator">=</span> e2<span class="token punctuation">.</span>id <span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> e2<span class="token punctuation">.</span>name <span class="token string">'人物'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> e1<span class="token punctuation">.</span>name <span class="token keyword">FROM</span> t_emp e1 <span class="token keyword">where</span> e1<span class="token punctuation">.</span>id<span class="token operator">=</span> d<span class="token punctuation">.</span>ceo<span class="token punctuation">)</span> <span class="token string">'掌门'</span> <span class="token keyword">from</span> t_emp e2 <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> t_dept d <span class="token keyword">on</span> e2<span class="token punctuation">.</span>deptid<span class="token operator">=</span>d<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="索引简介"><a href="#索引简介" class="header-anchor">#</a> 索引简介</h3> <ul><li><p>是什么</p> <ul><li>MySQL 官方对索引的定义为：索引（Index）是帮助 MySQL 高效获取数据的数据结构。可以得到索引的本质：
索引是数据结构。<strong>可以简单理解为排好序的快速查找数据结构。</strong> <ul><li>在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引。</li></ul></li> <li>一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上</li> <li>我们平常所说的索引，如果没有特别指明，都是指B树（多路搜索树，并不一定是二叉的）结构组织的索引。其中聚集索引，次要索引，覆盖索引，</li> <li>复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种类型的索引之外，还有哈稀索引（hash index）等。</li></ul></li> <li><p>优势</p> <ul><li>提高数据检索的效率，降低数据库的IO成本</li> <li>通过索引对数据进行的排序，降低数据排序的成本，降低了cpu的消耗</li></ul></li> <li><p>劣势</p> <ul><li>虽然索引大大提高了查询的速度，但是同时也降低了数据更新的速度，如对表进行insert，update，delete操作。因为更新表是，mysql不仅要更新数据，还要更新索引文件，都会调整更新所带来的的键值变化后的信息。</li> <li>实际上也是一张表，该表保存了主键和索引字段，并指向实体表的记录，所以索引列也是要占用磁盘空间的。</li> <li><strong>mysql的索引</strong> <ul><li>btree索引
<ul><li>mysql使用的是btree索引
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627093954.png" alt="20210627093954"></li> <li>【初始化介绍】
一颗 b 树，浅蓝色的块我们称之为一个磁盘块，可以看到每个磁盘块包含几个数据项（深蓝色所示）和指针（黄色
所示），如磁盘块 1 包含数据项 17 和 35，包含指针 P1、P2、P3，
P1 表示小于 17 的磁盘块，P2 表示在 17 和 35 之间的磁盘块，P3 表示大于 35 的磁盘块。
真实的数据存在于叶子节点即 3、5、9、10、13、15、28、29、36、60、75、79、90、99。
非叶子节点只不存储真实的数据，只存储指引搜索方向的数据项，如 17、35 并不真实存在于数据表中。</li> <li>【查找过程】
如果要查找数据项 29，那么首先会把磁盘块 1 由磁盘加载到内存，此时发生一次 IO，在内存中用二分查找确定 29
在 17 和 35 之间，锁定磁盘块 1 的 P2 指针，内存时间因为非常短（相比磁盘的 IO）可以忽略不计，通过磁盘块 1
的 P2 指针的磁盘地址把磁盘块 3 由磁盘加载到内存，发生第二次 IO，29 在 26 和 30 之间，锁定磁盘块 3 的 P2 指
针，通过指针加载磁盘块 8 到内存，发生第三次 IO，同时内存中做二分查找找到 29，结束查询，总计三次 IO。
真实的情况是，3 层的 b+树可以表示上百万的数据，如果上百万的数据查找只需要三次 IO，性能提高将是巨大的，
如果没有索引，每个数据项都要发生一次 IO，那么总共需要百万次的 IO，显然成本非常非常高。</li></ul></li> <li>b+tree索引
<ul><li>图解
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627094831.png" alt="20210627094831"></li> <li>B+Tree 与 B-Tree 的区别
<ul><li>1）B-树的关键字和记录是放在一起的，叶子节点可以看作外部节点，不包含任何信息；B+树的非叶子节点中只有关键字和指向下一个节点的索引，记录只放在叶子节点中。</li> <li>2）在 B-树中，越靠近根节点的记录查找时间越快，只要找到关键字即可确定记录的存在；而 B+树中每个记录
的查找时间基本是一样的，都需要从根节点走到叶子节点，而且在叶子节点中还要再比较关键字。从这个角度看 B- 树的性能好像要比 B+树好，而在实际应用中却是 B+树的性能要好些。因为 B+树的非叶子节点不存放实际的数据，
这样每个节点可容纳的元素个数比 B-树多，树高比 B-树小，这样带来的好处是减少磁盘访问次数。尽管 B+树找到
一个记录所需的比较次数要比 B-树多，但是一次磁盘访问的时间相当于成百上千次内存比较的时间，因此实际中
B+树的性能可能还会好些，而且 B+树的叶子节点使用指针连接在一起，方便顺序遍历（例如查看一个目录下的所有
文件，一个表中的所有记录等），这也是很多数据库和文件系统使用 B+树的缘故。</li></ul></li> <li>思考：为什么说 B+树比 B-树更适合实际应用中操作系统的文件索引和数据库索引？
<ul><li><ol><li>B+树的磁盘读写代价更低
B+树的内部结点并没有指向关键字具体信息的指针。因此其内部结点相对 B 树更小。如果把所有同一内部结点
的关键字存放在同一盘块中，那么盘块所能容纳的关键字数量也越多。一次性读入内存中的需要查找的关键字也就
越多。相对来说 IO 读写次数也就降低了。</li></ol></li> <li><ol start="2"><li>B+树的查询效率更加稳定
由于非终结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须
走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当。</li></ol></li></ul></li></ul></li> <li>聚簇索引和非聚簇索引
<ul><li>聚簇索引并不是一种单独的索引类型，而是一种数据存储方式。术语‘聚簇’表示数据行和相邻的键值聚簇的存储
在一起。如下图，左侧的索引就是聚簇索引，因为数据行在磁盘的排列和索引排序保持一致。
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627095219.png" alt="20210627095219"></li> <li>聚簇索引的好处：
按照聚簇索引排列顺序，查询显示一定范围数据的时候，由于数据都是紧密相连，数据库不不用从多
个数据块中提取数据，所以节省了大量的 io 操作。</li> <li>聚簇索引的限制：
对于 mysql 数据库目前只有 innodb 数据引擎支持聚簇索引，而 Myisam 并不支持聚簇索引。
由于数据物理存储排序方式只能有一种，所以每个 Mysql 的表只能有一个聚簇索引。一般情况下就是
该表的主键。
为了充分利用聚簇索引的聚簇的特性，所以 innodb 表的主键列尽量选用有序的顺序 id，而不建议用
无序的 id，比如 uuid 这种。</li></ul></li></ul></li></ul></li> <li><p>mysql索引分类</p> <ul><li>单值索引
概念：即一个索引只包含单个列，一个表可以有多个单列索引
语法：</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>随表一起创建：
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer <span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token punctuation">,</span>customer_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>customer_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
单独建单值索引：
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_customer_name <span class="token keyword">ON</span> customer<span class="token punctuation">(</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>唯一索引
概念：索引列的值必须唯一，但允许有空值</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>随表一起创建：
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer <span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token punctuation">,</span>customer_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>customer_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>customer_no<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
单独建唯一索引：
<span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> idx_customer_no <span class="token keyword">ON</span> customer<span class="token punctuation">(</span>customer_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li>主键索引
概念：设定为主键后数据库会自动建立索引，innodb为聚簇索引</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>随表一起建索引
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer <span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token punctuation">,</span>customer_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>customer_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
单独建主键索引：
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customer <span class="token keyword">add</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> customer<span class="token punctuation">(</span>customer_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
删除建主键索引：
<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> customer <span class="token keyword">drop</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">;</span>
修改建主键索引：
必须先删除掉<span class="token punctuation">(</span><span class="token keyword">drop</span><span class="token punctuation">)</span>原索引，再新建<span class="token punctuation">(</span><span class="token keyword">add</span><span class="token punctuation">)</span>索引
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>复合索引
概念：即一个索引包含多个列</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>随表一起建索引：
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> customer <span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token punctuation">,</span>customer_no <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>customer_name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>customer_no<span class="token punctuation">,</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
单独建索引：
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_no_name <span class="token keyword">ON</span> customer<span class="token punctuation">(</span>customer_no<span class="token punctuation">,</span>customer_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>索引创建时机</p> <ul><li>适合创建索引
<ul><li>主键自动建立唯一索引；</li> <li>频繁作为查询条件的字段应该创建索引</li> <li>查询中与其它表关联的字段，外键关系建立索引</li> <li>单键/组合索引的选择问题， 组合索引性价比更高</li> <li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度</li> <li>查询中统计或者分组字段</li></ul></li> <li>不适合创建索引
<ul><li>表记录太少</li> <li>经常增删改的表或者字段</li> <li>Where 条件里用不到的字段不创建索引</li> <li>过滤性不好的不适合建索引</li></ul></li></ul></li></ul> <h2 id="explain性能分析"><a href="#explain性能分析" class="header-anchor">#</a> Explain性能分析</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <ul><li>使用 EXPLAIN 关键字可以模拟优化器执行 SQL 查询语句，从而知道 MySQL 是如何处理你的 SQL 语句的。分析你的查询语句或是表结构的性能瓶颈。</li> <li>用法： Explain+SQL 语句。</li> <li>Explain 执行后返回的信息：
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627100649.png" alt="20210627100649"></li></ul> <h3 id="explain-准备工作"><a href="#explain-准备工作" class="header-anchor">#</a> Explain 准备工作</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t1<span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>content <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t2<span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>content <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t3<span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>content <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> t4<span class="token punctuation">(</span>id <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>content <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t1<span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>CONCAT<span class="token punctuation">(</span><span class="token string">'t1_'</span><span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t2<span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>CONCAT<span class="token punctuation">(</span><span class="token string">'t2_'</span><span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t3<span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>CONCAT<span class="token punctuation">(</span><span class="token string">'t3_'</span><span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> t4<span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>CONCAT<span class="token punctuation">(</span><span class="token string">'t4_'</span><span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="id"><a href="#id" class="header-anchor">#</a> id</h3> <ul><li>select 查询的序列号,包含一组数字，表示查询中执行 select 子句或操作表的顺序。</li> <li>①id 相同，执行顺序由上至下
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627102315.png" alt="20210627102315"></li> <li>②id 不同，id 不同，如果是子查询，id 的序号会递增，id 值越大优先级越高，越先被执行
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627102335.png" alt="20210627102335"></li> <li>③有相同也有不同
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627102351.png" alt="20210627102351">
id 如果相同，可以认为是一组，从上往下顺序执行；在所有组中，id 值越大，优先级越高，越先执行衍生 = DERIVED
关注点：id 号每个号码，表示一趟独立的查询。一个 sql 的查询趟数越少越好。</li></ul> <h3 id="select-type"><a href="#select-type" class="header-anchor">#</a> select_type</h3> <ul><li>select_type 代表查询的类型，主要是用于区别普通查询、联合查询、子查询等的复杂查询。</li></ul> <table><thead><tr><th>select_type 属性</th> <th>含义</th></tr></thead> <tbody><tr><td>SIMPLE</td> <td>简单的 select 查询,查询中不包含子查询或者 UNION</td></tr> <tr><td>PRIMARY</td> <td>查询中若包含任何复杂的子部分，最外层查询则被标记为 Primary</td></tr> <tr><td>DERIVED</td> <td>在 FROM 列表中包含的子查询被标记为 DERIVED(衍生) MySQL 会递归执行这些子查询, 把结果放在临时表里。</td></tr> <tr><td>SUBQUERY</td> <td>在SELECT或WHERE列表中包含了子查询</td></tr> <tr><td>DEPEDENT SUBQUERY</td> <td>在SELECT或WHERE列表中包含了子查询,子查询基于外层</td></tr> <tr><td>UNCACHEABLE SUBQUERY</td> <td>无法使用缓存的子查询</td></tr> <tr><td>UNION</td> <td>若第二个SELECT出现在UNION之后，则被标记为UNION；若UNION包含在FROM子句的子查询中,外层SELECT将被标记为：DERIVED</td></tr> <tr><td>UNION RESULT</td> <td>从UNION表获取结果的SELECT</td></tr></tbody></table> <h3 id="table"><a href="#table" class="header-anchor">#</a> table</h3> <ul><li>这个数据是基于哪张表的。</li></ul> <h3 id="type"><a href="#type" class="header-anchor">#</a> type</h3> <ul><li>type 是查询的访问类型。是较为重要的一个指标，结果值从最好到最坏依次是:
system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL ，一般来说，得保证查询至少达到 range 级别，最好能达到 ref。</li></ul> <h3 id="possible-keys"><a href="#possible-keys" class="header-anchor">#</a> possible_keys</h3> <ul><li>显示可能应用在这张表中的索引，一个或多个。查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用。</li></ul> <h3 id="key"><a href="#key" class="header-anchor">#</a> key</h3> <ul><li>实际使用的索引。如果为NULL，则没有使用索引。</li></ul> <h3 id="key-len"><a href="#key-len" class="header-anchor">#</a> key_len</h3> <ul><li>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。 key_len 字段能够帮你检查是否充分的利用上了索引。ken_len 越长，说明索引使用的越充分。
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627103143.png" alt="20210627103143"> <img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627103414.png" alt="20210627103414"></li> <li>如何计算：
<ul><li>①先看索引上字段的类型+长度比如 int=4 ; varchar(20) =20 ; char(20) =20</li> <li>②如果是 varchar 或者 char 这种字符串字段，视字符集要乘不同的值，比如 utf-8 要乘 3,GBK 要乘 2</li> <li>③varchar 这种动态字符串要加 2 个字节</li> <li>④允许为空的字段要加 1 个字节</li> <li>第一组：key_len=age 的字节长度+name 的字节长度=4+1 + ( 20*3+2)=5+62=67</li> <li>第二组：key_len=age 的字节长度=4+1=5
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627103329.png" alt="20210627103329"></li></ul></li></ul> <h3 id="ref"><a href="#ref" class="header-anchor">#</a> ref</h3> <ul><li>显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值。
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627103501.png" alt="20210627103501"></li></ul> <h3 id="rows"><a href="#rows" class="header-anchor">#</a> rows</h3> <ul><li>rows 列显示 MySQL 认为它执行查询时必须检查的行数。越少越好！
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627105940.png" alt="20210627105940"></li></ul> <h3 id="extra"><a href="#extra" class="header-anchor">#</a> Extra</h3> <ul><li><p>其他的额外重要的信息。</p></li> <li><p><strong>Using filesort</strong></p> <ul><li>说明 mysql 会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL 中无法利用索引完成的排序操作称为“文件排序”。</li> <li>出现 filesort 的情况：
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627104114.png" alt="20210627104114">
优化后
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627111454.png" alt="20210627111454">
查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度。</li></ul></li> <li><p><strong>Using temporary</strong>
-使了用临时表保存中间结果,MySQL 在对查询结果排序时使用临时表。常见于排序 order by 和分组查询 group by。</p> <ul><li>优化前：
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627111356.png" alt="20210627111356"></li> <li>优化后：
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627111421.png" alt="20210627111421"></li></ul></li> <li><p><strong>Using index</strong></p> <ul><li>Using index 代表表示相应的 select 操作中使用了覆盖索引(Covering Index)，避免访问了表的数据行，效率不错！
如果同时出现 using where，表明索引被用来执行索引键值的查找;如果没有同时出现 using where，表明索引只是用来读取数据而非利用索引执行查找。</li> <li>利用索引进行了排序或分组。</li></ul></li> <li><p><strong>Using where</strong></p> <ul><li>表明使用了 where 过滤</li></ul></li> <li><p><strong>Using join buffer</strong> <img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627111731.png" alt="20210627111731"></p></li> <li><p><strong>impossible where</strong></p> <ul><li>where 子句的值总是 false，不能用来获取任何元组。
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627111812.png" alt="20210627111812"></li></ul></li> <li><p><strong>select tables optimized away</strong></p> <ul><li>在没有 GROUPBY 子句的情况下，基于索引优化 MIN/MAX 操作或者对于 MyISAM 存储引擎优化 COUNT(*)操作，不必等到执行阶段再进行计算，查询执行计划生成的阶段即完成优化。</li> <li>在innodb中
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627111909.png" alt="20210627111909"></li> <li>在myisam中
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627111936.png" alt="20210627111936"></li></ul></li></ul> <h2 id="常见索引失效以及优化"><a href="#常见索引失效以及优化" class="header-anchor">#</a> 常见索引失效以及优化</h2> <h3 id="前期准备"><a href="#前期准备" class="header-anchor">#</a> 前期准备</h3> <ul><li>设置参数
<ul><li>在执行创建函数之前，首先请保证 log_bin_trust_function_creators 参数为 1，即 on 开启状态。否则会报错：</li> <li>查询：show variables like 'log_bin_trust_function_creators';</li> <li>设置：set global log_bin_trust_function_creators=1;</li> <li>当然，如上设置只存在于当前操作，想要永久生效，需要写入到配置文件中：
<ul><li>在[mysqld]中加上 log_bin_trust_function_creators=1</li></ul></li></ul></li> <li>创建表</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>dept<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>deptName<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>address<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> ceo <span class="token keyword">INT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>emp<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>empno<span class="token punctuation">`</span></span> <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>deptId<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token comment">#CONSTRAINT `fk_dept_id` FOREIGN KEY (`deptId`) REFERENCES `t_dept` (`id`)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">INNODB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li><p>编写随机函数</p> <ul><li>随机产生字符串、</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_string<span class="token punctuation">(</span>n <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> chars_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> return_str <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">WHILE</span> i <span class="token operator">&lt;</span> n <span class="token keyword">DO</span>
<span class="token keyword">SET</span> return_str <span class="token operator">=</span>CONCAT<span class="token punctuation">(</span>return_str<span class="token punctuation">,</span>SUBSTRING<span class="token punctuation">(</span>chars_str<span class="token punctuation">,</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">52</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> return_str<span class="token punctuation">;</span>
<span class="token keyword">END</span> $$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>随机产生部门编号</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> rand_num <span class="token punctuation">(</span>from_num <span class="token keyword">INT</span> <span class="token punctuation">,</span>to_num <span class="token keyword">INT</span><span class="token punctuation">)</span> <span class="token keyword">RETURNS</span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> i <span class="token operator">=</span> FLOOR<span class="token punctuation">(</span>from_num <span class="token operator">+</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>to_num <span class="token operator">-</span>from_num<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">RETURN</span> i<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>创建存储过程</p> <ul><li>创建往 emp 表中插入数据的存储过程</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> insert_emp<span class="token punctuation">(</span> <span class="token keyword">START</span> <span class="token keyword">INT</span> <span class="token punctuation">,</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">#set autocommit =0 把 autocommit 设置成 0</span>
<span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">REPEAT</span>
<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> emp <span class="token punctuation">(</span>empno<span class="token punctuation">,</span> NAME <span class="token punctuation">,</span>age <span class="token punctuation">,</span>deptid <span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">START</span><span class="token operator">+</span>i<span class="token punctuation">)</span> <span class="token punctuation">,</span>rand_string<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> rand_num<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UNTIL i <span class="token operator">=</span> max_num
<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token comment">#删除</span>
<span class="token comment"># DELIMITER ;</span>
<span class="token comment"># drop PROCEDURE insert_emp;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>创建往 dept 表中插入数据的存储过程</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">#执行存储过程，往 dept 表添加随机数据</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token identifier"><span class="token punctuation">`</span>insert_dept<span class="token punctuation">`</span></span><span class="token punctuation">(</span> max_num <span class="token keyword">INT</span> <span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> i <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> autocommit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">REPEAT</span>
<span class="token keyword">SET</span> i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> dept <span class="token punctuation">(</span> deptname<span class="token punctuation">,</span>address<span class="token punctuation">,</span>ceo <span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>rand_string<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_string<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>rand_num<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
UNTIL i <span class="token operator">=</span> max_num
<span class="token keyword">END</span> <span class="token keyword">REPEAT</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
<span class="token keyword">END</span>$$

<span class="token comment">#删除</span>
<span class="token comment"># DELIMITER ;</span>
<span class="token comment"># drop PROCEDURE insert_dept;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div></li> <li><p>调用存储过程</p> <ul><li>添加数据到部门表</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token keyword">CALL</span> insert_dept<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>添加数据到员工表</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> <span class="token punctuation">;</span>
<span class="token keyword">CALL</span> insert_emp<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span><span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>批量删除某个表上的所有索引</p> <ul><li>删除索引的存储过程</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> <span class="token identifier"><span class="token punctuation">`</span>proc_drop_index<span class="token punctuation">`</span></span><span class="token punctuation">(</span>dbname <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>tablename <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
<span class="token keyword">DECLARE</span> done <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> ct <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> _index <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> _cur <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span> index_name <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">STATISTICS</span> <span class="token keyword">WHERE</span>
table_schema<span class="token operator">=</span>dbname <span class="token operator">AND</span> table_name<span class="token operator">=</span>tablename <span class="token operator">AND</span> seq_in_index<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">AND</span> index_name <span class="token operator">&lt;&gt;</span><span class="token string">'PRIMARY'</span> <span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> <span class="token keyword">CONTINUE</span> <span class="token keyword">HANDLER</span> <span class="token keyword">FOR</span> <span class="token operator">NOT</span> FOUND <span class="token keyword">set</span> done<span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">;</span>
<span class="token keyword">OPEN</span> _cur<span class="token punctuation">;</span>
<span class="token keyword">FETCH</span> _cur <span class="token keyword">INTO</span> _index<span class="token punctuation">;</span>
<span class="token keyword">WHILE</span> _index<span class="token operator">&lt;&gt;</span><span class="token string">''</span> <span class="token keyword">DO</span>
<span class="token keyword">SET</span> <span class="token variable">@str</span> <span class="token operator">=</span> CONCAT<span class="token punctuation">(</span><span class="token string">&quot;drop index &quot;</span><span class="token punctuation">,</span>_index<span class="token punctuation">,</span><span class="token string">&quot; on &quot;</span><span class="token punctuation">,</span>tablename <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">PREPARE</span> sql_str <span class="token keyword">FROM</span> <span class="token variable">@str</span> <span class="token punctuation">;</span>
<span class="token keyword">EXECUTE</span> sql_str<span class="token punctuation">;</span>
<span class="token keyword">DEALLOCATE</span> <span class="token keyword">PREPARE</span> sql_str<span class="token punctuation">;</span>
<span class="token keyword">SET</span> _index<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">FETCH</span> _cur <span class="token keyword">INTO</span> _index<span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token keyword">WHILE</span><span class="token punctuation">;</span>
<span class="token keyword">CLOSE</span> _cur<span class="token punctuation">;</span>
<span class="token keyword">END</span>$$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><ul><li>执行存储过程</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">#调用：</span>
<span class="token keyword">DELIMITER</span> $$
<span class="token keyword">CALL</span> proc_drop_index<span class="token punctuation">(</span><span class="token string">&quot;dbname&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tablename&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <h3 id="全值匹配我最爱"><a href="#全值匹配我最爱" class="header-anchor">#</a> 全值匹配我最爱</h3> <ul><li>有以下sql</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">and</span> deptid<span class="token operator">=</span><span class="token number">4</span>
<span class="token keyword">EXPLAIN</span> <span class="token keyword">SELECT</span> SQL_NO_CACHE <span class="token operator">*</span> <span class="token keyword">FROM</span> emp <span class="token keyword">WHERE</span> emp<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">30</span> <span class="token operator">and</span> deptid<span class="token operator">=</span><span class="token number">4</span> <span class="token operator">AND</span> emp<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'abcd'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li>建立索引</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_age_deptid_name <span class="token keyword">ON</span> emp<span class="token punctuation">(</span>age<span class="token punctuation">,</span>deptid<span class="token punctuation">,</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627141355.png" alt="20210627141355"> <img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627141929.png" alt="20210627141929"></p> <p>结论：</p> <ul><li>全值匹配我最爱指的是，查询的字段按照顺序在索引中都可以匹配到</li> <li>sql中查询字段的顺序，跟使用索引中字段的顺序，没有关系。优化器会在不影响sql执行的前提下，自动优化。</li></ul> <h3 id="最佳左前缀法则"><a href="#最佳左前缀法则" class="header-anchor">#</a> 最佳左前缀法则</h3> <p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627142430.png" alt="20210627142430"></p> <ul><li>查询字段与索引字段顺序的不同会导致，索引无法充分使用，甚至索引失效！</li> <li>原因：使用复合索引，需要遵循最佳左前缀法则，即如果索引了多列，要遵守最左前缀法则。指的是查询从索引的最<strong>左前列开始并且不跳过索引中的列</strong>。</li> <li>结论：过滤条件要使用索引必须按照索引建立时的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用。</li></ul> <h3 id="不要在索引列上做任何计算"><a href="#不要在索引列上做任何计算" class="header-anchor">#</a> 不要在索引列上做任何计算</h3> <p>不在索引列上做任何操作（计算、函数、(自动 or 手动)类型转换），会导致索引失效而转向全表扫描。</p> <ul><li>在查询列上使用了函数</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> <span class="token keyword">LEFT</span><span class="token punctuation">(</span>age<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627142740.png" alt="20210627142740"></p> <p>结论：等号左边无计算！</p> <ul><li>在查询列上做了转换</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">index</span> idx_name <span class="token keyword">on</span> emp<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">'30000'</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token number">30000</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>字符串不加单引号，则会在 name 列上做一次转换！</p> <p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627143054.png" alt="20210627143054"></p> <p>结论：等号右边无转换！</p> <h3 id="索引列上不能有范围查询"><a href="#索引列上不能有范围查询" class="header-anchor">#</a> 索引列上不能有范围查询</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> deptid <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">and</span> name <span class="token operator">=</span> <span class="token string">'abcd'</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> deptid <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token operator">and</span> name <span class="token operator">=</span> <span class="token string">'abcd'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627143419.png" alt="20210627143419"></p> <p>建议：将可能做范围查询的字段的索引顺序放在最后</p> <h3 id="尽量使用覆盖索引"><a href="#尽量使用覆盖索引" class="header-anchor">#</a> 尽量使用覆盖索引</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> deptid <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">and</span> name <span class="token operator">=</span> <span class="token string">'abcd'</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> age<span class="token punctuation">,</span>deptid<span class="token punctuation">,</span>name <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">and</span> deptid <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">and</span> name <span class="token operator">=</span> <span class="token string">'abcd'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627143700.png" alt="20210627143700"></p> <p>即查询列和索引列一致，不要写 select *!</p> <h3 id="使用不等于-或者-的时候"><a href="#使用不等于-或者-的时候" class="header-anchor">#</a> 使用不等于(!= 或者&lt;&gt;)的时候</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">!=</span> <span class="token number">30</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627143915.png" alt="20210627143915"></p> <p>mysql 在使用不等于(!= 或者&lt;&gt;)时，有时会无法使用索引会导致全表扫描。</p> <h3 id="字段的-is-not-null-和-is-null"><a href="#字段的-is-not-null-和-is-null" class="header-anchor">#</a> 字段的 is not null 和 is null</h3> <p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627144121.png" alt="20210627144121"></p> <p>当字段允许为 Null 的条件下：
is not null 用不到索引，is null 可以用到索引。</p> <h3 id="like-的前后模糊匹配"><a href="#like-的前后模糊匹配" class="header-anchor">#</a> like 的前后模糊匹配</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%a'</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'%a%'</span><span class="token punctuation">;</span>
<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'a%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627144325.png" alt="20210627144325"></p> <p>前缀不能出现模糊匹配！</p> <h3 id="减少使用-or"><a href="#减少使用-or" class="header-anchor">#</a> 减少使用 or</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token operator">or</span> age <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627144634.png" alt="20210627144634"></p> <p>使用 union all 或者 union 来替代：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">30</span> <span class="token keyword">union</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> emp <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627144759.png" alt="20210627144759"></p> <h3 id="口诀"><a href="#口诀" class="header-anchor">#</a> 口诀</h3> <div class="language-custom line-numbers-mode"><pre class="language-text"><code>全职匹配我最爱，最左前缀要遵守；
带头大哥不能死，中间兄弟不能断；
索引列上少计算，范围之后全失效；
LIKE 百分写最右，覆盖索引不写*；
不等空值还有 OR，索引影响要注意；
VAR 引号不可丢，SQL 优化有诀窍。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="关联查询优化"><a href="#关联查询优化" class="header-anchor">#</a> 关联查询优化</h2> <h3 id="关联查询优化前期准备"><a href="#关联查询优化前期准备" class="header-anchor">#</a> 关联查询优化前期准备</h3> <ul><li>建表语句</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>class<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>card<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>book<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
<span class="token identifier"><span class="token punctuation">`</span>bookid<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>card<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>bookid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> class<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> book<span class="token punctuation">(</span>card<span class="token punctuation">)</span> <span class="token keyword">VALUES</span><span class="token punctuation">(</span>FLOOR<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token punctuation">(</span>RAND<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="案例"><a href="#案例" class="header-anchor">#</a> 案例</h3> <ul><li>left join</li></ul> <p>①EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card = book.card;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627145931.png" alt="20210627145931">
②如何优化？在哪个表上建立索引？
alter table book add index idx_card(card);
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627150021.png" alt="20210627150021">
③删除 book 表的索引：drop index idx_card on book;
在 class 表上建立索引：alter table class add index idx_card(card);
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627150253.png" alt="20210627150253">
结论：
①在优化关联查询时，只有在被驱动表上建立索引才有效！
②left join 时，左侧的为驱动表，右侧为被驱动表！</p> <ul><li>inner join</li></ul> <p>①EXPLAIN SELECT * FROM book inner join class on class.card=book.card;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627150548.png" alt="20210627150548">
②两个查询表调换顺序，发现结果也是一样的！
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627150737.png" alt="20210627150737">
③在 book 表中，删除 9 条记录
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627150840.png" alt="20210627150840"> <img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627150933.png" alt="20210627150933">
④结论：inner join 时，mysql 会自己帮你把小结果集的表选为驱动表。
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627151048.png" alt="20210627151048">
⑤straight_join: 效果和 inner join 一样，但是会强制将左侧作为驱动表！</p> <ul><li>四个关联查询案例分析</li></ul> <p>explain select ed.name '人物',c.name '掌门' from (select e.name,d.ceo from t_emp e left join t_dept d on e.deptid = d.id) ed left join t_emp c on ed.ceo = c.id;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627151516.png" alt="20210627151516">
explain select e.name '人物',tmp.name '掌门' from t_emp e left join (select d.id did,e.name from t_dept d left join t_emp e on d.ceo = e.id) tmp on e.deptid = tmp.did;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627151814.png" alt="20210627151814">
上述两个案例，第一个查询效率较高，且有优化的余地。第二个案例中，子查询作为被驱动表，由于子查询是虚表，
无法建立索引，因此不能优化。</p> <p>结论：
子查询尽量不要放在被驱动表，有可能使用不到索引；
left join时，尽量让实体表作为被驱动表。</p> <p>EXPLAIN SELECT e1.name '人物',e2.name '掌门' FROM t_emp e1
LEFT JOIN t_dept d on e1.deptid = d.id
LEFT JOIN
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627152331.png" alt="20210627152331">
Explain SELECT e2.name '人物', (SELECT e1.name FROM t_emp e1 where e1.id= d.ceo) '掌门' from t_emp e2 LEFT JOIN
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627152404.png" alt="20210627152404"></p> <p>结论：能够直接多表关联的尽量直接关联，不用子查询！</p> <h2 id="子查询优化"><a href="#子查询优化" class="header-anchor">#</a> 子查询优化</h2> <h3 id="子查询优化案例"><a href="#子查询优化案例" class="header-anchor">#</a> 子查询优化案例</h3> <p>取所有不为掌门人的员工，按年龄分组！</p> <p>explain select age as '年龄',count(<em>) as '人数' from t_emp where id not in (select ceo from t_dept where ceo is not null) group by age;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627152946.png" alt="20210627152946">
如何优化？
①解决 dept 表的全表扫描，建立 ceo 字段的索引：
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627154423.png" alt="20210627154423">
②进一步优化，替换 not in。
上述 SQL 可以替换为：
explain select age as '年龄',count(</em>) as '人数' from t_emp e left join t_dept d on e.id=d.ceo where d.id is null group by age;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627154721.png" alt="20210627154721">
结论： 在范围判断时，尽量不要使用 not in 和 not exists，使用 left join on xxx is null 代替。</p> <h2 id="排序分组优化"><a href="#排序分组优化" class="header-anchor">#</a> 排序分组优化</h2> <p>where 条件和 on 的判断这些过滤条件，作为优先优化的部分，是要被先考虑的！其次，如果有分组和排序，那么也要考虑 grouo by 和 order by。</p> <h3 id="无过滤不索引"><a href="#无过滤不索引" class="header-anchor">#</a> 无过滤不索引</h3> <p>create index idx_age_deptid_name on emp (age,deptid,name);
explain select * from emp where age=40 order by deptid;
explain select * from emp order by age,deptid;
explain select * from emp order by age,deptid limit 10;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627155156.png" alt="20210627155156">
using filesort 说明进行了手工排序！原因在于没有 where 作为过滤条件！
结论： 无过滤，不索引。where，limt 都相当于一种过滤条件，所以才能使用上索引！</p> <h3 id="顺序错-必排序"><a href="#顺序错-必排序" class="header-anchor">#</a> 顺序错，必排序</h3> <p>①explain select <em>from emp where age=45 order by deptid,name;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627155426.png" alt="20210627155426">
②explain select</em>from emp where age=45 order by deptid,empno;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627155513.png" alt="20210627155513">
empno 字段并没有建立索引，因此也无法用到索引，此字段需要排序！
③explain select <em>from emp where age=45 order by name,deptid;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627155550.png" alt="20210627155550">
④explain select</em>from emp where deptid=45 order by age;
where 两侧列的顺序可以变换，效果相同，但是 order by 列的顺序不能随便变换！
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627155638.png" alt="20210627155638">
deptid 作为过滤条件的字段，无法使用索引，因此排序没法用上索引</p> <h3 id="方向反-必排序"><a href="#方向反-必排序" class="header-anchor">#</a> 方向反，必排序</h3> <p>①explain select<em>from emp where age=45 order by deptid desc, name desc ;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627155815.png" alt="20210627155815">
如果可以用上索引的字段都使用正序或者逆序，实际上是没有任何影响的，无非将结果集调换顺序。
②explain select</em>from emp where age=45 order by deptid asc, name desc ;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627155923.png" alt="20210627155923">
如果排序的字段，顺序有差异，就需要将差异的部分，进行一次倒置顺序，因此还是需要手动排序的！</p> <h3 id="索引的选择"><a href="#索引的选择" class="header-anchor">#</a> 索引的选择</h3> <ul><li>①首先，清除 emp 上面的所有索引，只保留主键索引！
drop index idx_age_deptid_name on emp;</li> <li>②查询：年龄为 30 岁的，且员工编号小于 101000 的用户，按用户名称排序
explain SELECT SQL_NO_CACHE * FROM emp WHERE age =30 AND empno &lt;101000 ORDER BY NAME ;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627160124.png" alt="20210627160124"></li> <li>③全表扫描肯定是不被允许的，因此我们要考虑优化。
思路：首先需要让 where 的过滤条件，用上索引；
查询中，age.empno 是查询的过滤条件，而 name 则是排序的字段，因此我们来创建一个此三个字段的复合索引：
create index idx_age_empno_name on emp(age,empno,name);
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627160334.png" alt="20210627160334">
再次查询，发现 using filesort 依然存在。
原因： empno 是范围查询，因此导致了索引失效，所以 name 字段无法使用索引排序。
所以，三个字段的符合索引，没有意义，因为 empno 和 name 字段只能选择其一！</li> <li>④解决： 鱼与熊掌不可兼得，因此，要么选择 empno,要么选择 name
drop index idx_age_empno_name on emp;
create index idx_age_name on emp(age,name);
create index idx_age_empno on emp(age,empno);
两个索引同时存在，mysql 会选择哪个？
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627160523.png" alt="20210627160523">
explain SELECT SQL_NO_CACHE * FROM emp use index(idx_age_name) WHERE age =30 AND empno &lt;101000 ORDER BY NAME ;
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627160630.png" alt="20210627160630"></li> <li>原因：所有的排序都是在条件过滤之后才执行的，所以如果条件过滤了大部分数据的话，几百几千条数据进行排序其实并不是很消耗性能，即使索引优化了排序但实际提升性能很有限。 相对的 empno&lt;101000 这个条件如果没有用到索引的话，要对几万条的数据进行扫描，这是非常消耗性能的，使用 empno 字段的范围查询，过滤性更好（empno 从 100000 开始）！</li> <li>结论： 当范围条件和 group by 或者 order by 的字段出现二选一时 ，优先观察条件字段的过滤数量，如果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围字段上。反之，亦然。</li></ul> <h3 id="using-filesort"><a href="#using-filesort" class="header-anchor">#</a> using filesort</h3> <ul><li>mysql 的排序算法
<ul><li>①双路排序
<ul><li>MySQL 4.1 之前是使用双路排序,字面意思就是两次扫描磁盘，最终得到数据，读取行指针和 orderby 列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出。</li> <li>从磁盘取排序字段，在 buffer 进行排序，再从磁盘取其他字段。</li> <li>简单来说，取一批数据，要对磁盘进行了两次扫描，众所周知，I\O 是很耗时的，所以在 mysql4.1 之后，出现了第二种改进的算法，就是单路排序。</li></ul></li> <li>②单路排序
<ul><li>从磁盘读取查询需要的所有列，按照 order by 列在 buffer 对它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机 IO 变成了顺序 IO,但是它会使用更多的空间，因为它把每一行都保存在内存中了。</li></ul></li> <li>③单路排序的问题
<ul><li>由于单路是后出的，总体而言好过双路。但是存在以下问题：
在 sort_buffer 中，方法 B 比方法 A 要多占用很多空间，因为方法 B 是把所有字段都取出, 所以有可能取出的数据的总大小超出了 sort_buffer 的容量，导致每次只能取 sort_buffer 容量大小的数据，进行排序（创建 tmp 文件，多路合并），排完再取取 sort_buffer 容量大小，再排……从而多次 I/O。
结论：本来想省一次 I/O 操作，反而导致了大量的 I/O 操作，反而得不偿失。</li></ul></li></ul></li> <li>如何优化
①增大 sort_butter_size 参数的设置
<ul><li>不管用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的 1M-8M 之间调整。
②增大 max_length_for_sort_data 参数的设置</li> <li>mysql 使用单路排序的前提是排序的字段大小要小于 max_length_for_sort_data。
提高这个参数，会增加用改进算法的概率。但是如果设的太高，数据总容量超出 sort_buffer_size 的概率就增大，
明显症状是高的磁盘 I/O 活动和低的处理器使用率。（1024-8192 之间调整）。
③减少 select 后面的查询的字段。</li> <li>当 Query 的字段大小总和小于 max_length_for_sort_data 而且排序字段不是 TEXT|BLOB 类型时，会用改进后的
算法——单路排序， 否则用老算法——多路排序。</li> <li>两种算法的数据都有可能超出 sort_buffer 的容量，超出之后，会创建 tmp 文件进行合并排序，导致多次 I/O，
但是用单路排序算法的风险会更大一些,所以要提高 sort_buffer_size。</li></ul></li></ul> <h3 id="使用覆盖索引"><a href="#使用覆盖索引" class="header-anchor">#</a> 使用覆盖索引</h3> <ul><li>覆盖索引：SQL 只需要通过索引就可以返回查询所需要的数据，而不必通过二级索引查到主键之后再去查询数据。
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210627161350.png" alt="20210627161350"></li></ul> <h3 id="group-by"><a href="#group-by" class="header-anchor">#</a> group by</h3> <p>group by 使用索引的原则几乎跟 order by 一致 ，唯一区别是 group by 即使没有过滤条件用到索引，也可以直接使用索引。</p> <h2 id="截取查询分析"><a href="#截取查询分析" class="header-anchor">#</a> 截取查询分析</h2> <h3 id="慢查询分析"><a href="#慢查询分析" class="header-anchor">#</a> 慢查询分析</h3> <ul><li><p>是什么</p> <ul><li>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。</li> <li>具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行10秒以上的语句。</li> <li>由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析。</li></ul></li> <li><p>怎么用</p> <ul><li><strong>默认情况下，MySQL 数据库没有开启慢查询日志，需要我们手动来设置这个参数。</strong></li> <li><strong>当然，如果不是调优需要的话，一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</li> <li>开启设置</li></ul> <table><thead><tr><th>SQL 语句</th> <th>描述</th> <th>备注</th></tr></thead> <tbody><tr><td>SHOW VARIABLES LIKE '%slow_query_log%';</td> <td>查看慢查询日志是否开启</td> <td>默认情况下 slow_query_log 的值为 OFF，表示慢查询日志是禁用的</td></tr> <tr><td>set global slow_query_log=1;</td> <td>开启慢查询日志</td> <td>备注</td></tr> <tr><td>SHOW VARIABLES LIKE 'long_query_time%';</td> <td>查看慢查询设定阈值</td> <td>单位秒</td></tr> <tr><td>set long_query_time=1</td> <td>设定慢查询阈值</td> <td>单位秒</td></tr></tbody></table> <ul><li>如永久生效需要修改配置文件 my.cnf 中[mysqld]下配置</li></ul> <div class="language-config line-numbers-mode"><pre class="language-text"><code>[mysqld]
slow_query_log=1
slow_query_log_file=/var/lib/mysql/atguigu-slow.log
long_query_time=3
log_output=FILE
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>运行查询时间长的 sql，打开慢查询日志查看</p></li> <li><p>日志分析工具 mysqldumpslow</p> <ul><li>查看mysqldumpslow的帮助信息
<ul><li>mysqldumpslow --help</li></ul></li> <li>查看mysqldumpslow的帮助信息</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>得到返回记录集最多的 <span class="token number">10</span> 个 <span class="token keyword">SQL</span>
mysqldumpslow <span class="token operator">-</span>s r <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>atguigu<span class="token operator">-</span>slow<span class="token punctuation">.</span>log
得到访问次数最多的 <span class="token number">10</span> 个 <span class="token keyword">SQL</span>
mysqldumpslow <span class="token operator">-</span>s c <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>atguigu<span class="token operator">-</span>slow<span class="token punctuation">.</span>log
得到按照时间排序的前 <span class="token number">10</span> 条里面含有左连接的查询语句
mysqldumpslow <span class="token operator">-</span>s t <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">-</span>g <span class="token string">&quot;left join&quot;</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>atguigu<span class="token operator">-</span>slow<span class="token punctuation">.</span>log
另外建议在使用这些命令时结合 <span class="token operator">|</span> 和 more 使用 ，否则有可能出现爆屏情况
mysqldumpslow <span class="token operator">-</span>s r <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">/</span>var<span class="token operator">/</span>lib<span class="token operator">/</span>mysql<span class="token operator">/</span>atguigu<span class="token operator">-</span>slow<span class="token punctuation">.</span>log <span class="token operator">|</span> more
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul></li></ul> <h3 id="show-processlist"><a href="#show-processlist" class="header-anchor">#</a> SHOW PROCESSLIST</h3> <ul><li>是什么
<ul><li>查询 mysql 进程列表，可以杀掉故障进程</li></ul></li> <li>怎么用
<ul><li>show processlist;</li> <li>kill pid;</li></ul></li></ul> <h2 id="主从复制"><a href="#主从复制" class="header-anchor">#</a> 主从复制</h2> <h3 id="复制的基本原理"><a href="#复制的基本原理" class="header-anchor">#</a> 复制的基本原理</h3> <ul><li>slave 会从 master 读取 binlog 来进行数据同步</li> <li>三步骤+原理图
<img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210628163041.png" alt="20210628163041">
MySQL 复制过程分成三步：
<ul><li>master 将改变记录到二进制日志（binary log）。这些记录过程叫做二进制日志事件，binary log events；</li> <li>slave 将 master 的 binary log events 拷贝到它的中继日志（relay log）；</li> <li>slave 重做中继日志中的事件，将改变应用到自己的数据库中。 MySQL 复制是异步的且串行化的</li></ul></li></ul> <h3 id="复制的基本原则"><a href="#复制的基本原则" class="header-anchor">#</a> 复制的基本原则</h3> <ul><li>每个 slave 只有一个 master</li> <li>每个 slave 只能有一个唯一的服务器 ID</li> <li>每个 master 可以有多个 salve</li></ul> <h3 id="复制的最大问题"><a href="#复制的最大问题" class="header-anchor">#</a> 复制的最大问题</h3> <ul><li>因为发生多次 IO，存在延时问题</li></ul> <h3 id="一主一从常见配置"><a href="#一主一从常见配置" class="header-anchor">#</a> 一主一从常见配置</h3> <ul><li><p>mysql 版本一致且后台以服务运行</p></li> <li><p>主从都配置在[mysqld]结点下，都是小写
主机修改 my.ini 配置文件</p> <p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210628163810.png" alt="20210628163810"></p> <div class="language-config line-numbers-mode"><pre class="language-text"><code>主服务器唯一 ID
server-id=1
启用二进制日志
log-bin=自己本地的路径/data/mysqlbin
log-bin=D:/devSoft/MySQLServer5.5/data/mysqlbin
设置不要复制的数据库
binlog-ignore-db=mysql
设置需要复制的数据库
binlog-do-db=需要复制的主数据库名字
设置 logbin 格式
binlog_format=STATEMENT（默认）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>mysql 主从复制起始时，从机不继承主机数据</p></li> <li><p>logbin 格式</p></li></ul> <div class="language-config line-numbers-mode"><pre class="language-text"><code>binlog_format=STATEMENT（默认）
binlog_format=ROW
binlog_format=MIXED
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/qouson/my-pic-bed/pic/20210628164420.png" alt="20210628164420"></p> <ul><li>从机配置文件修改 my.cnf 的[mysqld]栏位下</li></ul> <div class="language-config line-numbers-mode"><pre class="language-text"><code>#从机服务 id
server-id = 2
#注意 my.cnf 中有 server-id = 1
#设置中继日志
relay-log=mysql-relay
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>因修改过配置文件，请主机+从机都重启后台 mysql 服务</li> <li>主机从机都关闭防火墙、安全工具（腾讯管家等）</li> <li>在 Windows 主机上建立帐户并授权 slave</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">#创建用户，并授权</span>
<span class="token keyword">GRANT</span> <span class="token keyword">REPLICATION</span> SLAVE <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'备份账号'</span><span class="token variable">@'从机器数据库 IP'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>查询 master 的状态，并记录下 File 和 Position 的值</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">#查询 master 的状态</span>
<span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>执行完此步骤后不要再操作主服务器 MYSQL，防止主服务器状态值变化</p> <ul><li>在 Linux 从机上配置需要复制的主机</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">#查询 master 的状态</span>
CHANGE MASTER <span class="token keyword">TO</span> MASTER_HOST<span class="token operator">=</span><span class="token string">'主机 IP'</span><span class="token punctuation">,</span>MASTER_USER<span class="token operator">=</span><span class="token string">'创建用户名'</span><span class="token punctuation">,</span>MASTER_PASSWORD<span class="token operator">=</span><span class="token string">'创建的密码'</span><span class="token punctuation">,</span> MASTER_LOG_FILE<span class="token operator">=</span><span class="token string">'File 名字'</span><span class="token punctuation">,</span>MASTER_LOG_POS<span class="token operator">=</span>Position 数字<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>启动从服务器复制功能</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">start</span> slave<span class="token punctuation">;</span>
<span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>下面两个参数都是 Yes，则说明主从配置成功！</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>Slave_IO_Running: Yes
Slave_SQL_Running: Yes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li>主机新建库、新建表、insert 记录，从机复制</li> <li>如何停止从服务复制功能</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>stop slave<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="速查表"><a href="#速查表" class="header-anchor">#</a> 速查表</h2> <p>show index from table_name
CREATE INDEX idx_name ON table_name(column_name);
alter table table_name add index idx_name(column_name);
drop index idx_name on table_name;</p></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/qouson/my-java-note/edit/master/docs/30.中间件/10.mysql/10.mysql.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/05/23, 23:50:19</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><!----> <a href="/pages/9061b3/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">版本介绍</div></a></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/9061b3/">版本介绍</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/284b7d/"><div>
            springMVC
            <!----></div></a> <span class="date">05-23</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/a78a74/"><div>
            常用命令
            <!----></div></a> <span class="date">05-23</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/8497b8/"><div>
            故障分析
            <!----></div></a> <span class="date">05-23</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:jiangjinchao1642@foxmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/qouson" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2024
    <span>qouson</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.a811c800.js" defer></script><script src="/assets/js/2.06722832.js" defer></script><script src="/assets/js/35.7a4be827.js" defer></script>
  </body>
</html>
